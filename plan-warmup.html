<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan Warm-Up Multi ESP</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1);
      --primary-color: #45b7d1;
      --dark-bg: rgba(18, 18, 18, 0.95);
      --card-bg: rgba(30, 30, 30, 0.8);
      --text-light: rgba(255, 255, 255, 0.9);
      --text-muted: rgba(255, 255, 255, 0.6);
      --error-color: #ff6b6b;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      margin: 0; 
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--dark-bg);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 24px;
      box-shadow: 
        0 32px 64px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      animation: slideUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    h2 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #ffffff, #b3b3b3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: glow 3s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2) drop-shadow(0 0 20px rgba(69, 183, 209, 0.5)); }
    }

    label {
      font-weight: 600;
      margin-top: 25px;
      display: block;
      color: var(--text-light);
      font-size: 1.1em;
    }

    input, select {
      width: 100%;
      padding: 15px;
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(40, 40, 40, 0.8);
      color: white;
      font-size: 1em;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(69, 183, 209, 0.3);
    }

    input.error, select.error {
      border-color: var(--error-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
    }

    .error-message {
      color: var(--error-color);
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }

    .config-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .config-field {
      flex: 1;
    }

    .config-field label {
      margin-top: 0;
      margin-bottom: 8px;
    }

    .esp-container {
      margin-top: 20px;
    }

    .esp-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .esp-row .esp-name-container {
      flex: 1 1 60%;
    }

    .esp-row input[type=number] {
      flex: 1 1 40%;
    }

    .esp-row .remove-btn {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 12px;
    }

    .esp-row .remove-btn:hover {
      background: #ff5252;
      transform: scale(1.05);
    }

    button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 15px 30px;
      margin-top: 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2), 
        transparent
      );
      transition: left 0.6s ease;
    }

    button:hover::before {
      left: 100%;
    }

    .results-container {
      display: flex;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .table-container {
      flex: 1;
      min-width: 400px;
    }

    #output {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    th, td {
      padding: 12px 15px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    th {
      background-color: rgba(69, 183, 209, 0.2);
      color: var(--primary-color);
      font-weight: 600;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.05);
    }

    .week-column {
      background-color: rgba(255, 193, 7, 0.1);
      font-weight: 600;
    }

    .date-column {
      background-color: rgba(52, 152, 219, 0.1);
      font-weight: 500;
      min-width: 100px;
    }

    .chart-container {
      flex: 1;
      min-width: 500px;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .chart-title {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
      font-size: 1.5em;
    }
    
    .chart {
      width: 100%;
      height: 400px;
      position: relative;
    }
    
    .chart-line {
      position: absolute;
      bottom: 30px;
      left: 50px;
      right: 20px;
      height: 2px;
      background: var(--text-muted);
    }
    
    .chart-lines {
      position: relative;
      height: 350px;
      width: 100%;
    }
    
    .chart-x-axis {
      display: flex;
      justify-content: space-between;
      padding-left: 50px;
      padding-right: 20px;
      margin-top: 5px;
    }
    
    .chart-x-label {
      font-size: 0.7em;
      color: var(--text-muted);
      transform: rotate(-45deg);
      transform-origin: left top;
      white-space: nowrap;
      margin-left: 5px;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
      justify-content: center;
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .chart-legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 8px;
    }

    .chart-grid-line {
      position: absolute;
      width: 100%;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }

    .chart-y-axis {
      position: absolute;
      left: 30px;
      top: 0;
      bottom: 30px;
      width: 20px;
    }

    .chart-y-label {
      position: absolute;
      left: 0;
      transform: translateY(50%);
      font-size: 0.8em;
      color: var(--text-muted);
    }

    .chart-path {
      fill: none;
      stroke-width: 2;
      stroke-linejoin: round;
      stroke-linecap: round;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .btn-group button {
      flex: 1;
      min-width: 200px;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 30px;
      padding: 15px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 1em;
      font-weight: 500;
      border-radius: 8px;
      background: rgba(69, 183, 209, 0.1);
      border: 1px solid rgba(69, 183, 209, 0.3);
      transition: all 0.3s ease;
    }

    .back-link:hover {
      color: white;
      background: rgba(69, 183, 209, 0.2);
      border-color: rgba(69, 183, 209, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(69, 183, 209, 0.2);
    }

    .date-info {
      background: rgba(69, 183, 209, 0.1);
      border: 1px solid rgba(69, 183, 209, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .date-info h3 {
      margin: 0 0 10px 0;
      color: var(--primary-color);
    }

    .date-info p {
      margin: 5px 0;
      color: var(--text-light);
    }

    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .container {
        padding: 25px 20px;
        max-width: 100%;
      }
      
      h2 {
        font-size: 2em;
        margin-bottom: 25px;
      }

      .config-row {
        flex-direction: column;
        gap: 15px;
        margin-bottom: 25px;
      }

      .config-field {
        width: 100%;
      }

      .config-field input {
        width: 100%;
        max-width: 100%;
      }
      
      .esp-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .esp-row .esp-name-container,
      .esp-row input[type=number] {
        width: 100%;
        flex: none;
      }

      .esp-row .remove-btn {
        margin-top: 0;
        align-self: flex-start;
      }
      
      .results-container {
        flex-direction: column;
      }
      
      .table-container, .chart-container {
        min-width: 100%;
      }
      
      .btn-group {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-group button {
        width: 100%;
        min-width: unset;
      }

      .back-link {
        margin-top: 25px;
        padding: 12px;
        font-size: 0.95em;
      }

      #output {
        margin-top: 30px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px 6px;
      }

      label {
        font-size: 1em;
        margin-top: 20px;
      }

      input, select {
        padding: 12px;
        font-size: 16px;
      }

      button {
        padding: 12px 20px;
        font-size: 0.95em;
      }

      .chart {
        height: 300px;
      }
      
      .chart-x-label {
        font-size: 0.6em;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
      }

      h2 {
        font-size: 1.8em;
      }

      input, select {
        padding: 10px;
      }

      button {
        padding: 10px 15px;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 6px 4px;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Plan Warm-Up - Multi ESP</h2>
    
    <div class="config-row">
      <div class="config-field">
        <label for="startDateInput">Date de début :</label>
        <input type="date" id="startDateInput" required />
        <div class="error-message" id="dateError">La date doit être valide</div>
      </div>
      <div class="config-field">
        <label for="weeksInput">Nombre de semaines :</label>
        <input type="number" id="weeksInput" min="1" max="12" value="4" required />
      </div>
      <div class="config-field">
        <label for="daysPerWeekInput">Nombre de jours par semaine :</label>
        <input type="number" id="daysPerWeekInput" min="1" max="7" value="3" required />
      </div>
    </div>

    <div class="esp-container">
      <label>Configuration des ESP :</label>
      <div id="espInputs">
        <!-- Les lignes ESP seront ajoutées dynamiquement ici -->
      </div>
      <button type="button" onclick="addESP()">+ Ajouter un ESP</button>
    </div>

    <button onclick="generatePlan()">Générer le plan</button>

    <div id="dateInfo"></div>
    
    <div class="results-container">
      <div class="table-container">
        <div id="output"></div>
      </div>
      
      <div id="chartContainer" class="chart-container" style="display: none;">
        <div class="chart-title">📈 Progression du Volume d'Envoi</div>
        <div class="chart">
          <div class="chart-lines" id="chartLines"></div>
          <div class="chart-line"></div>
          <div class="chart-y-axis" id="chartYAxis"></div>
          <div class="chart-x-axis" id="chartXAxis"></div>
        </div>
        <div class="chart-legend" id="chartLegend"></div>
      </div>
    </div>
    
    <div class="btn-group">
      <button id="csvBtn" onclick="downloadCSV()" disabled>📥 Télécharger CSV</button>
      <button id="chartBtn" onclick="toggleChart()" disabled>📊 Afficher/Masquer le Graphique</button>
    </div>
    
    <a href="javascript:history.back()" class="back-link">
      ← Retour à la page précédente
    </a>
  </div>

<script>
  // Variables globales
  let generatedPlan = null;
  let generatedDays = 0;
  let espVolumesCibles = {};
  let espNames = [];
  let weeksCount = 0;
  let daysPerWeekCount = 0;
  let startDate = null;
  let endDate = null;
  let planDates = [];

  // Liste des ESP prédéfinis
  const predefinedESPs = [
    "Gmail", "Outlook", "Yahoo", "AOL", "iCloud", "ProtonMail",
    "Zoho", "Mail.com", "GMX", "Yandex", "Orange", "SFR",
    "Free", "Bouygues", "Laposte.net", "Hotmail", "Live",
    "MSN", "Comcast", "Verizon", "ATT"
  ];

  // Couleurs pour le graphique
  const chartColors = [
    '#45b7d1', '#ff6b6b', '#4ecdc4', '#a178df', '#ffbe0b', 
    '#fb5607', '#8338ec', '#3a86ff', '#ff006e', '#0ead69'
  ];

  // Initialiser la date de début à aujourd'hui et ajouter les ESP par défaut
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    const dateInput = document.getElementById('startDateInput');
    
    dateInput.value = todayString;
    
    // Ajouter 6 ESP par défaut
    for (let i = 0; i < 6; i++) {
      if (i < predefinedESPs.length) {
        addESP(predefinedESPs[i]);
      } else {
        addESP();
      }
    }
  });

  // Fonction pour ajouter un ESP
  function addESP(preselectedESP = null) {
    const container = document.getElementById('espInputs');
    const div = document.createElement('div');
    div.classList.add('esp-row');
    
    const rowId = 'esp-row-' + Date.now();
    div.id = rowId;
    
    div.innerHTML = `
      <div class="esp-name-container">
        <select class="espName" onchange="handleESPSelect(this, '${rowId}')">
          <option value="">-- Sélectionner un ESP --</option>
          ${predefinedESPs.map(esp => 
            `<option value="${esp}" ${preselectedESP === esp ? 'selected' : ''}>${esp}</option>`
          ).join('')}
          <option value="custom">Autre (personnalisé)</option>
        </select>
        <input type="text" placeholder="Nom ESP personnalisé" class="espCustomName" 
               style="display: none; margin-top: 8px;" />
        <div class="error-message">Ce nom d'ESP existe déjà</div>
      </div>
      <input type="number" placeholder="Volume cible" class="espVolume" min="1" required />
      <button type="button" class="remove-btn" onclick="removeESP('${rowId}')">✕</button>
    `;
    container.appendChild(div);
    
    if (preselectedESP && !predefinedESPs.includes(preselectedESP)) {
      const select = div.querySelector('.espName');
      select.value = 'custom';
      const customInput = div.querySelector('.espCustomName');
      customInput.style.display = 'block';
      customInput.value = preselectedESP;
    }
    
    updateRemoveButtons();
  }

  function handleESPSelect(selectElement, rowId) {
    const row = document.getElementById(rowId);
    const customInput = row.querySelector('.espCustomName');
    
    if (selectElement.value === 'custom') {
      customInput.style.display = 'block';
      customInput.required = true;
    } else {
      customInput.style.display = 'none';
      customInput.required = false;
      customInput.value = '';
    }
  }

  function removeESP(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
      row.remove();
      updateRemoveButtons();
      checkDuplicates();
    }
  }

  function updateRemoveButtons() {
    const espRows = document.querySelectorAll('.esp-row');
    espRows.forEach((row, index) => {
      const removeBtn = row.querySelector('.remove-btn');
      if (espRows.length > 1) {
        removeBtn.style.display = 'block';
      } else {
        removeBtn.style.display = 'none';
      }
    });
  }

  function checkDuplicates() {
    const espNameInputs = document.querySelectorAll('.espName');
    const usedNames = new Set();
    let hasDuplicates = false;

    espNameInputs.forEach(input => {
      let name = '';
      if (input.value === 'custom') {
        const customInput = input.closest('.esp-name-container').querySelector('.espCustomName');
        name = customInput.value.trim().toLowerCase();
      } else {
        name = input.value.trim().toLowerCase();
      }
      
      const errorMessage = input.closest('.esp-name-container').querySelector('.error-message');
      
      if (name && usedNames.has(name)) {
        input.classList.add('error');
        errorMessage.style.display = 'block';
        hasDuplicates = true;
      } else {
        input.classList.remove('error');
        errorMessage.style.display = 'none';
        if (name) {
          usedNames.add(name);
        }
      }
    });

    return !hasDuplicates;
  }

  function generatePlan() {
    const startDateInput = document.getElementById('startDateInput');
    const dateError = document.getElementById('dateError');
    const startDateValue = startDateInput.value;
    
    // Validation de la date
    if (!startDateValue) {
      dateError.style.display = 'block';
      startDateInput.classList.add('error');
      alert("Veuillez sélectionner une date de début");
      return;
    }

    const selectedDate = new Date(startDateValue);
    if (isNaN(selectedDate.getTime())) {
      dateError.style.display = 'block';
      startDateInput.classList.add('error');
      alert("Date invalide");
      return;
    }

    dateError.style.display = 'none';
    startDateInput.classList.remove('error');

    const weeks = parseInt(document.getElementById('weeksInput').value);
    const daysPerWeek = parseInt(document.getElementById('daysPerWeekInput').value);

    if (isNaN(weeks) || isNaN(daysPerWeek) || weeks < 1 || daysPerWeek < 1) {
      alert("Nombre de semaines et jours par semaine doivent être des nombres valides >= 1");
      return;
    }

    // Récupérer les noms et volumes des ESP
    const espRows = document.querySelectorAll('.esp-row');
    espNames = [];
    const espVolumesRaw = [];
    
    for (let row of espRows) {
      const select = row.querySelector('.espName');
      let name = '';
      
      if (select.value === 'custom') {
        const customInput = row.querySelector('.espCustomName');
        name = customInput.value.trim();
      } else {
        name = select.value.trim();
      }
      
      const volumeInput = row.querySelector('.espVolume');
      const volume = parseInt(volumeInput.value);
      
      if (name && !isNaN(volume) && volume > 0) {
        espNames.push(name);
        espVolumesRaw.push(volume);
      } else {
        alert("Veuillez remplir tous les champs ESP et volumes correctement");
        return;
      }
    }
    
    if (espNames.length === 0) {
      alert("Merci d'entrer au moins un ESP valide avec un nom et un volume");
      return;
    }

    // Vérifier les doublons
    if (!checkDuplicates()) {
      alert("Veuillez corriger les doublons dans les noms d'ESP avant de générer le plan.");
      return;
    }

    weeksCount = weeks;
    daysPerWeekCount = daysPerWeek;
    startDate = new Date(startDateValue);

    // Créer l'objet ESP avec volumes
    const esps = {};
    espVolumesCibles = {};
    for (let i = 0; i < espNames.length; i++) {
      esps[espNames[i]] = espVolumesRaw[i];
      espVolumesCibles[espNames[i]] = espVolumesRaw[i];
    }

    const factor = 1.3;
    const totalDays = weeks * daysPerWeek;
    generatedDays = totalDays;

    // Générer les dates du plan - version simplifiée
    planDates = [];
    let currentDate = new Date(startDate);
    
    for (let i = 0; i < totalDays; i++) {
      planDates.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    endDate = planDates[planDates.length - 1];

    generatedPlan = {};

    // Générer le plan pour chaque ESP
    for (let esp of espNames) {
      const volume = esps[esp];
      let plan = [];
      let joursProgression = totalDays - daysPerWeek;

      let start = volume / Math.pow(factor, joursProgression - 1);
      if (start < 1) start = 1;

      for (let j = 0; j < joursProgression; j++) {
        let val = Math.round(start * Math.pow(factor, j));
        if (val > volume) val = volume;
        plan.push(val);
      }

      for (let j = 0; j < daysPerWeek; j++) {
        plan.push(volume);
      }

      if (plan.length < generatedDays) {
        plan = plan.concat(Array(generatedDays - plan.length).fill(volume));
      } else if (plan.length > generatedDays) {
        plan = plan.slice(0, generatedDays);
      }

      generatedPlan[esp] = plan;
    }

    displayDateInfo();
    displayPlan();
    
    // Activer les boutons de téléchargement
    document.getElementById('csvBtn').disabled = false;
    document.getElementById('chartBtn').disabled = false;
  }

function getWeekNumber(dateObj, startDate, daysPerWeek) {
    // Calcul du numéro de semaine en fonction des jours d'envoi par semaine
    const timeDiff = dateObj - startDate;
    const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    return Math.floor(daysDiff / daysPerWeek) + 1; // Semaine 1, 2, 3...
}
  function displayDateInfo() {
    const dateInfoHtml = `
      <div class="date-info">
        <h3>📅 Informations sur le planning</h3>
        <p><strong>Date de début :</strong> ${formatDate(startDate)}</p>
        <p><strong>Date de fin :</strong> ${formatDate(endDate)}</p>
        <p><strong>Durée totale :</strong> ${generatedDays} jours d'envoi sur ${weeksCount} semaines</p>
      </div>
    `;
    document.getElementById('dateInfo').innerHTML = dateInfoHtml;
  }

  function formatDate(date) {
    return date.toLocaleDateString('fr-FR', {
      weekday: 'short',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  }

   function displayPlan() {
    let html = "<table><thead><tr><th>Semaine</th><th>Date</th>";
    for (let esp of espNames) {
      html += `<th>${esp}</th>`;
    }
    html += "</tr></thead><tbody>";

    // Calculer le lundi de la semaine de début
    const startMonday = new Date(startDate);
    startMonday.setDate(startDate.getDate() - startDate.getDay() + (startDate.getDay() === 0 ? -6 : 1));

    for (let day = 0; day < generatedDays; day++) {
      const currentDate = planDates[day];
      // Calculer la semaine en fonction du lundi de départ
const weekNumber = getWeekNumber(currentDate, startDate, daysPerWeekCount);      
      const dateStr = formatDate(currentDate);
      html += `<tr><td class="week-column">${weekNumber}</td><td class="date-column">${dateStr}</td>`;
      for (let esp of espNames) {
        html += `<td>${generatedPlan[esp][day]}</td>`;
      }
      html += "</tr>";
    }

    html += "<tr style='font-weight:bold; background:rgba(69, 183, 209, 0.1);'>";
    html += "<td class='week-column'>-</td><td class='date-column'>Volume total</td>";
    for (let esp of espNames) {
      html += `<td>${espVolumesCibles[esp]}</td>`;
    }
    html += "</tr>";

    html += "</tbody></table>";

    document.getElementById('output').innerHTML = html;
    generateChart();
  }


  function generateChart() {
    if (!generatedPlan || espNames.length === 0) return;
    
    const chartLines = document.getElementById('chartLines');
    const chartLegend = document.getElementById('chartLegend');
    const chartYAxis = document.getElementById('chartYAxis');
    const chartXAxis = document.getElementById('chartXAxis');
    
    chartLines.innerHTML = '';
    chartLegend.innerHTML = '';
    chartYAxis.innerHTML = '';
    chartXAxis.innerHTML = '';
    
    // Trouver le volume maximum pour l'échelle
    let maxVolume = 0;
    for (let esp of espNames) {
      const espMax = Math.max(...generatedPlan[esp]);
      if (espMax > maxVolume) maxVolume = espMax;
    }
    
    // Arrondir le volume max à la centaine supérieure
    maxVolume = Math.ceil(maxVolume / 100) * 100;
    
    // Créer l'axe Y
    const yAxisSteps = 5;
    for (let i = 0; i <= yAxisSteps; i++) {
      const value = Math.round((maxVolume / yAxisSteps) * i);
      const position = (i / yAxisSteps) * 100;
      
      const yLabel = document.createElement('div');
      yLabel.className = 'chart-y-label';
      yLabel.style.bottom = `${position}%`;
      yLabel.textContent = value.toLocaleString();
      
      chartYAxis.appendChild(yLabel);
      
      // Ligne de grille
      const gridLine = document.createElement('div');
      gridLine.className = 'chart-grid-line';
      gridLine.style.bottom = `${position}%`;
      
      chartLines.appendChild(gridLine);
    }
    
    // Créer l'axe X avec les dates exactes du tableau
    for (let day = 0; day < generatedDays; day++) {
      const dateStr = planDates[day].toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'});
      const xLabel = document.createElement('div');
      xLabel.className = 'chart-x-label';
      xLabel.textContent = dateStr;
      
      chartXAxis.appendChild(xLabel);
    }
    
    // Créer les courbes pour chaque ESP
    espNames.forEach((esp, index) => {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      path.setAttribute('width', '100%');
      path.setAttribute('height', '100%');
      path.setAttribute('viewBox', `0 0 ${generatedDays * 50} 350`);
      path.style.position = 'absolute';
      path.style.left = '50px';
      path.style.right = '20px';
      path.style.top = '0';
      path.style.height = '350px';
      
      const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      pathElement.className = 'chart-path';
      pathElement.setAttribute('stroke', chartColors[index % chartColors.length]);
      
      let pathData = '';
      for (let day = 0; day < generatedDays; day++) {
        const value = generatedPlan[esp][day];
        const x = (day / (generatedDays - 1)) * (generatedDays * 50 - 50);
        const y = 350 - (value / maxVolume) * 350;
        
        if (day === 0) {
          pathData += `M ${x} ${y}`;
        } else {
          pathData += ` L ${x} ${y}`;
        }
        
        // Ajouter un point pour chaque jour
        const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        point.setAttribute('cx', x);
        point.setAttribute('cy', y);
        point.setAttribute('r', '4');
        point.setAttribute('fill', chartColors[index % chartColors.length]);
        point.setAttribute('stroke', 'white');
        point.setAttribute('stroke-width', '1');
        point.setAttribute('data-esp', esp);
        point.setAttribute('data-day', day);
        point.setAttribute('data-value', value);
        
        path.appendChild(point);
      }
      
      pathElement.setAttribute('d', pathData);
      path.appendChild(pathElement);
      chartLines.appendChild(path);
      
      // Créer la légende
      const legendItem = document.createElement('div');
      legendItem.className = 'chart-legend-item';
      legendItem.onclick = function() {
        const path = pathElement;
        const isHidden = path.style.opacity === '0.3';
        path.style.opacity = isHidden ? '1' : '0.3';
        this.style.opacity = isHidden ? '1' : '0.6';
      };
      
      const colorBox = document.createElement('div');
      colorBox.className = 'chart-legend-color';
      colorBox.style.background = chartColors[index % chartColors.length];
      
      const espName = document.createElement('span');
      espName.textContent = esp;
      
      legendItem.appendChild(colorBox);
      legendItem.appendChild(espName);
      chartLegend.appendChild(legendItem);
    });
    
    // Afficher le conteneur du graphique
    document.getElementById('chartContainer').style.display = 'block';
  }
  
  function toggleChart() {
    const chart = document.getElementById('chartContainer');
    chart.style.display = chart.style.display === 'none' ? 'block' : 'none';
  }

  function downloadCSV() {
    if (!generatedPlan || espNames.length === 0) {
      alert("Génère d'abord un plan");
      return;
    }

    let csv = "Semaine,Date," + espNames.join(",") + "\n";
    for (let day = 0; day < generatedDays; day++) {
      const weekNumber = getWeekNumber(planDates[day], startDate);
      const dateStr = planDates[day].toLocaleDateString('fr-FR');
      let row = [weekNumber, dateStr];
      for (let esp of espNames) {
        row.push(generatedPlan[esp][day]);
      }
      csv += row.join(",") + "\n";
    }

    // Ajouter la ligne totale

    // Ajouter la ligne totale
    csv += "-,Volume total," + espNames.map(esp => espVolumesCibles[esp]).join(",") + "\n";

    let blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "plan_warmup_dates.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>
</body>
</html>